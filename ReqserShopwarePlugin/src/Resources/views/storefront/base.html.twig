{% sw_extends '@Storefront/storefront/base.html.twig' %}

{% block base_body_script %}
    {{ parent() }}

    <script>
        // Reqser Language Detection - Inline JavaScript (no build required)
        (function() {
            'use strict';
            
            // Check if debug mode is enabled via URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const debugMode = urlParams.get('reqserdebugmode') === 'true';
            
            // Always log debug mode status (this will help us verify it's working)
            if (debugMode) {
                console.log('🐛 Reqser Debug Mode: ENABLED');
            }
            
            // Debug logging function
            function debugLog(...args) {
                if (debugMode) {
                    console.log(...args);
                }
            }
            
            function debugWarn(...args) {
                if (debugMode) {
                    console.warn(...args);
                }
            }
            
            function debugError(...args) {
                if (debugMode) {
                    console.error(...args);
                }
            }
            
            debugLog('🚀 Reqser Language Detection: Script loaded');
            
            
            // Always run the check - let the server decide based on configuration and cookies

            // Perform language detection check
            async function checkLanguage() {
                debugLog('🔍 Starting language detection check...');
                
                try {
                    const checkUrl = '{{ path('frontend.reqser.language_detection.check') }}';
                    debugLog('📡 Making AJAX request to:', checkUrl);
                    
                    const headers = {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json',
                    };
                    
                    const response = await fetch(checkUrl, {
                        method: 'GET',
                        credentials: 'same-origin',
                        headers: headers,
                    });

                    debugLog('📥 Response status:', response.status, response.statusText);

                    if (!response.ok) {
                        debugWarn('❌ Reqser Language Detection: Request failed with status:', response.status);
                        const errorText = await response.text();
                        debugWarn('❌ Error response:', errorText);
                        return;
                    }

                    const data = await response.json();
                    debugLog('📊 Response data:', data);
                    
                    // Show configuration for debugging
                    debugLog('🎯 Primary browser language:', data.browserLanguage || 'unknown');
                    debugLog('🏠 Current domain language code:', data.currentLanguageCode || 'unknown');
                    if (data.availableDomains) {
                        debugLog('🌐 Available domains:', data.availableDomains);
                    }
                    if (data.config) {
                        debugLog('⚙️ Plugin Configuration:', data.config);
                        debugLog('🔧 Session Ignore Mode:', data.sessionIgnoreMode);
                        debugLog('✅ Already Checked in Session:', data.alreadyCheckedInSession);
                    }

                    if (data.success && data.shouldRedirect && data.redirectUrl) {
                        // Log the redirect for debugging
                        debugLog('🚀 Reqser Language Detection: Redirecting to', data.redirectUrl, 'Reason:', data.reason);
                        
                        // Perform the redirect
                        window.location.href = data.redirectUrl;
                    } else if (data.success) {
                        debugLog('✅ Reqser Language Detection: No redirect needed. Reason:', data.reason);
                    } else {
                        // Error occurred
                        debugWarn('⚠️ Reqser Language Detection: Check failed. Reason:', data.reason);
                    }

                } catch (error) {
                    debugError('💥 Reqser Language Detection: Request failed:', error);
                }
            }

            // Run language detection when DOM is ready
            debugLog('📋 Document ready state:', document.readyState);
            
            if (document.readyState === 'loading') {
                debugLog('⏳ Waiting for DOMContentLoaded...');
                document.addEventListener('DOMContentLoaded', function() {
                    debugLog('✅ DOMContentLoaded fired, starting language check');
                    checkLanguage();
                });
            } else {
                debugLog('✅ DOM already ready, starting language check immediately');
                checkLanguage();
            }
        })();
    </script>
{% endblock %}
